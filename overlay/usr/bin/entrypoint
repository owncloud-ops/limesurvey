#!/usr/bin/env sh

set -eo pipefail

/usr/local/bin/gomplate -V -o /etc/php7/php.ini -f /etc/templates/php.ini.tmpl
/usr/local/bin/gomplate -V -o /var/www/app/application/config/config.php -f /etc/templates/config.php.tmpl

printf "\nPrepare survey ..."

if [ -n "$LIME_DB_HOST" ]
then
    printf "\nWait for database server on '%s:%s' ...\n" "$LIME_DB_HOST" "${LIME_DB_PORT:-3306}"
    /usr/local/bin/wait-for "${LIME_DB_HOST}":"${LIME_DB_PORT:-3306}"
else
    printf "\nRequired environment variable '\$LIME_DATABASE_HOST' not set. Exiting ..."
    exit 1
fi

printf "\nSetup lime survey"
php /var/www/app/application/commands/console.php install "${LIME_ADMIN_USER}" "${LIME_ADMIN_PASSWORD}" "${LIME_ADMIN_USER}" "${LIME_ADMIN_EMAIL}"


printf "\nStarting survey ...\n"

php-fpm7 -F &
exec nginx -g "daemon off;"
